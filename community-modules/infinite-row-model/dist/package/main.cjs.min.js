var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__export=(o,e)=>{for(var t in e)__defProp(o,t,{get:e[t],enumerable:!0})},__copyProps=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of __getOwnPropNames(e))!__hasOwnProp.call(o,i)&&i!==t&&__defProp(o,i,{get:()=>e[i],enumerable:!(s=__getOwnPropDesc(e,i))||s.enumerable});return o},__toCommonJS=o=>__copyProps(__defProp({},"__esModule",{value:!0}),o),__decorateClass=(o,e,t,s)=>{for(var i=s>1?void 0:s?__getOwnPropDesc(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(i=(s?a(e,t,i):a(i))||i);return s&&i&&__defProp(e,t,i),i},__decorateParam=(o,e)=>(t,s)=>e(t,s,o),main_exports={};__export(main_exports,{InfiniteRowModelModule:()=>InfiniteRowModelModule}),module.exports=__toCommonJS(main_exports);var import_core4=require("@ag-grid-community/core"),import_core3=require("@ag-grid-community/core"),import_core2=require("@ag-grid-community/core"),import_core=require("@ag-grid-community/core"),InfiniteBlock=class extends import_core.RowNodeBlock{constructor(o,e,t){super(o),this.parentCache=e,this.params=t,this.startRow=o*t.blockSize,this.endRow=this.startRow+t.blockSize}postConstruct(){this.createRowNodes()}getBlockStateJson(){return{id:""+this.getId(),state:{blockNumber:this.getId(),startRow:this.getStartRow(),endRow:this.getEndRow(),pageStatus:this.getState()}}}setDataAndId(o,e,t){import_core._.exists(e)?o.setDataAndId(e,t.toString()):o.setDataAndId(void 0,void 0)}loadFromDatasource(){const o=this.createLoadParams();if(import_core._.missing(this.params.datasource.getRows)){console.warn("AG Grid: datasource is missing getRows method");return}window.setTimeout(()=>{this.params.datasource.getRows(o)},0)}processServerFail(){}createLoadParams(){return{startRow:this.getStartRow(),endRow:this.getEndRow(),successCallback:this.pageLoaded.bind(this,this.getVersion()),failCallback:this.pageLoadFailed.bind(this,this.getVersion()),sortModel:this.params.sortModel,filterModel:this.params.filterModel,context:this.gridOptionsService.getGridCommonParams().context}}forEachNode(o,e,t){this.rowNodes.forEach((s,i)=>{this.startRow+i<t&&o(s,e.next())})}getLastAccessed(){return this.lastAccessed}getRow(o,e=!1){e||(this.lastAccessed=this.params.lastAccessedSequence.next());const t=o-this.startRow;return this.rowNodes[t]}getStartRow(){return this.startRow}getEndRow(){return this.endRow}createRowNodes(){this.rowNodes=[];for(let o=0;o<this.params.blockSize;o++){const e=this.startRow+o,t=new import_core.RowNode(this.beans);t.setRowHeight(this.params.rowHeight),t.uiLevel=0,t.setRowIndex(e),t.setRowTop(this.params.rowHeight*e),this.rowNodes.push(t)}}processServerResult(o){this.rowNodes.forEach((t,s)=>{const i=o.rowData?o.rowData[s]:void 0;!t.id&&t.alreadyRendered&&i&&(this.rowNodes[s]=new import_core.RowNode(this.beans),this.rowNodes[s].setRowIndex(t.rowIndex),this.rowNodes[s].setRowTop(t.rowTop),this.rowNodes[s].setRowHeight(t.rowHeight),t.clearRowTopAndRowIndex()),this.setDataAndId(this.rowNodes[s],i,this.startRow+s)});const e=o.rowCount!=null&&o.rowCount>=0?o.rowCount:void 0;this.parentCache.pageLoaded(this,e)}destroyRowNodes(){this.rowNodes.forEach(o=>{o.clearRowTopAndRowIndex()})}};__decorateClass([(0,import_core.Autowired)("beans")],InfiniteBlock.prototype,"beans",2),__decorateClass([import_core.PostConstruct],InfiniteBlock.prototype,"postConstruct",1),__decorateClass([import_core.PreDestroy],InfiniteBlock.prototype,"destroyRowNodes",1);var _InfiniteCache=class u extends import_core2.BeanStub{constructor(e){super(),this.lastRowIndexKnown=!1,this.blocks={},this.blockCount=0,this.rowCount=e.initialRowCount,this.params=e}setBeans(e){this.logger=e.create("InfiniteCache")}getRow(e,t=!1){const s=Math.floor(e/this.params.blockSize);let i=this.blocks[s];if(!i){if(t)return;i=this.createBlock(s)}return i.getRow(e)}createBlock(e){const t=this.createBean(new InfiniteBlock(e,this,this.params));return this.blocks[t.getId()]=t,this.blockCount++,this.purgeBlocksIfNeeded(t),this.params.rowNodeBlockLoader.addBlock(t),t}refreshCache(){if(this.blockCount==0){this.purgeCache();return}this.getBlocksInOrder().forEach(t=>t.setStateWaitingToLoad()),this.params.rowNodeBlockLoader.checkBlockToLoad()}destroyAllBlocks(){this.getBlocksInOrder().forEach(e=>this.destroyBlock(e))}getRowCount(){return this.rowCount}isLastRowIndexKnown(){return this.lastRowIndexKnown}pageLoaded(e,t){this.isAlive()&&(this.logger.log(`onPageLoaded: page = ${e.getId()}, lastRow = ${t}`),this.checkRowCount(e,t),this.onCacheUpdated())}purgeBlocksIfNeeded(e){const t=this.getBlocksInOrder().filter(n=>n!=e),s=(n,h)=>h.getLastAccessed()-n.getLastAccessed();t.sort(s);const i=this.params.maxBlocksInCache>0,r=i?this.params.maxBlocksInCache-1:null,a=u.MAX_EMPTY_BLOCKS_TO_KEEP-1;t.forEach((n,h)=>{const c=n.getState()===InfiniteBlock.STATE_WAITING_TO_LOAD&&h>=a,d=i?h>=r:!1;if(c||d){if(this.isBlockCurrentlyDisplayed(n)||this.isBlockFocused(n))return;this.removeBlockFromCache(n)}})}isBlockFocused(e){const t=this.focusService.getFocusCellToUseAfterRefresh();if(!t||t.rowPinned!=null)return!1;const s=e.getStartRow(),i=e.getEndRow();return t.rowIndex>=s&&t.rowIndex<i}isBlockCurrentlyDisplayed(e){const t=e.getStartRow(),s=e.getEndRow()-1;return this.rowRenderer.isRangeInRenderedViewport(t,s)}removeBlockFromCache(e){e&&this.destroyBlock(e)}checkRowCount(e,t){if(typeof t=="number"&&t>=0)this.rowCount=t,this.lastRowIndexKnown=!0;else if(!this.lastRowIndexKnown){const i=(e.getId()+1)*this.params.blockSize+this.params.overflowSize;this.rowCount<i&&(this.rowCount=i)}}setRowCount(e,t){this.rowCount=e,import_core2._.exists(t)&&(this.lastRowIndexKnown=t),this.lastRowIndexKnown||this.rowCount%this.params.blockSize===0&&this.rowCount++,this.onCacheUpdated()}forEachNodeDeep(e){const t=new import_core2.NumberSequence;this.getBlocksInOrder().forEach(s=>s.forEachNode(e,t,this.rowCount))}getBlocksInOrder(){const e=(s,i)=>s.getId()-i.getId();return import_core2._.getAllValuesInObject(this.blocks).sort(e)}destroyBlock(e){delete this.blocks[e.getId()],this.destroyBean(e),this.blockCount--,this.params.rowNodeBlockLoader.removeBlock(e)}onCacheUpdated(){if(this.isAlive()){this.destroyAllBlocksPastVirtualRowCount();const e={type:import_core2.Events.EVENT_STORE_UPDATED};this.eventService.dispatchEvent(e)}}destroyAllBlocksPastVirtualRowCount(){const e=[];this.getBlocksInOrder().forEach(t=>{t.getId()*this.params.blockSize>=this.rowCount&&e.push(t)}),e.length>0&&e.forEach(t=>this.destroyBlock(t))}purgeCache(){this.getBlocksInOrder().forEach(e=>this.removeBlockFromCache(e)),this.lastRowIndexKnown=!1,this.rowCount===0&&(this.rowCount=this.params.initialRowCount),this.onCacheUpdated()}getRowNodesInRange(e,t){const s=[];let i=-1,r=!1;const a=new import_core2.NumberSequence;import_core2._.missing(e)&&(r=!0);let n=!1;return this.getBlocksInOrder().forEach(c=>{if(!n){if(r&&i+1!==c.getId()){n=!0;return}i=c.getId(),c.forEachNode(d=>{const l=d===e||d===t;(r||l)&&s.push(d),l&&(r=!r)},a,this.rowCount)}}),n||r?[]:s}};_InfiniteCache.MAX_EMPTY_BLOCKS_TO_KEEP=2,__decorateClass([(0,import_core2.Autowired)("rowRenderer")],_InfiniteCache.prototype,"rowRenderer",2),__decorateClass([(0,import_core2.Autowired)("focusService")],_InfiniteCache.prototype,"focusService",2),__decorateClass([__decorateParam(0,(0,import_core2.Qualifier)("loggerFactory"))],_InfiniteCache.prototype,"setBeans",1),__decorateClass([import_core2.PreDestroy],_InfiniteCache.prototype,"destroyAllBlocks",1);var InfiniteCache=_InfiniteCache,InfiniteRowModel=class extends import_core3.BeanStub{getRowBounds(o){return{rowHeight:this.rowHeight,rowTop:this.rowHeight*o}}ensureRowHeightsValid(o,e,t,s){return!1}init(){this.gridOptionsService.isRowModelType("infinite")&&(this.rowHeight=this.gridOptionsService.getRowHeightAsNumber(),this.addEventListeners(),this.addDestroyFunc(()=>this.destroyCache()),this.verifyProps())}verifyProps(){this.gridOptionsService.exists("initialGroupOrderComparator")&&import_core3._.warnOnce("initialGroupOrderComparator cannot be used with Infinite Row Model as sorting is done on the server side")}start(){this.setDatasource(this.gridOptionsService.get("datasource"))}destroyDatasource(){this.datasource&&(this.getContext().destroyBean(this.datasource),this.rowRenderer.datasourceChanged(),this.datasource=null)}addEventListeners(){this.addManagedListener(this.eventService,import_core3.Events.EVENT_FILTER_CHANGED,this.onFilterChanged.bind(this)),this.addManagedListener(this.eventService,import_core3.Events.EVENT_SORT_CHANGED,this.onSortChanged.bind(this)),this.addManagedListener(this.eventService,import_core3.Events.EVENT_NEW_COLUMNS_LOADED,this.onColumnEverything.bind(this)),this.addManagedListener(this.eventService,import_core3.Events.EVENT_STORE_UPDATED,this.onCacheUpdated.bind(this)),this.addManagedPropertyListener("datasource",()=>this.setDatasource(this.gridOptionsService.get("datasource"))),this.addManagedPropertyListener("cacheBlockSize",()=>this.resetCache()),this.addManagedPropertyListener("rowHeight",()=>{this.rowHeight=this.gridOptionsService.getRowHeightAsNumber(),this.cacheParams.rowHeight=this.rowHeight,this.updateRowHeights()})}onFilterChanged(){this.reset()}onSortChanged(){this.reset()}onColumnEverything(){let o;this.cacheParams?o=this.isSortModelDifferent():o=!0,o&&this.reset()}isSortModelDifferent(){return!import_core3._.jsonEquals(this.cacheParams.sortModel,this.sortController.getSortModel())}getType(){return"infinite"}setDatasource(o){this.destroyDatasource(),this.datasource=o,o&&this.reset()}isEmpty(){return!this.infiniteCache}isRowsToRender(){return!!this.infiniteCache}getNodesInRangeForSelection(o,e){return this.infiniteCache?this.infiniteCache.getRowNodesInRange(o,e):[]}reset(){if(!this.datasource)return;this.gridOptionsService.getCallback("getRowId")!=null||this.selectionService.reset("rowDataChanged"),this.resetCache()}createModelUpdatedEvent(){return{type:import_core3.Events.EVENT_MODEL_UPDATED,newPage:!1,newPageSize:!1,newData:!1,keepRenderedRows:!0,animate:!1}}resetCache(){this.destroyCache(),this.cacheParams={datasource:this.datasource,filterModel:this.filterManager.getFilterModel(),sortModel:this.sortController.getSortModel(),rowNodeBlockLoader:this.rowNodeBlockLoader,initialRowCount:this.gridOptionsService.get("infiniteInitialRowCount"),maxBlocksInCache:this.gridOptionsService.get("maxBlocksInCache"),rowHeight:this.gridOptionsService.getRowHeightAsNumber(),overflowSize:this.gridOptionsService.get("cacheOverflowSize"),blockSize:this.gridOptionsService.get("cacheBlockSize"),lastAccessedSequence:new import_core3.NumberSequence},this.infiniteCache=this.createBean(new InfiniteCache(this.cacheParams)),this.eventService.dispatchEventOnce({type:import_core3.Events.EVENT_ROW_COUNT_READY});const o=this.createModelUpdatedEvent();this.eventService.dispatchEvent(o)}updateRowHeights(){this.forEachNode(e=>{e.setRowHeight(this.rowHeight),e.setRowTop(this.rowHeight*e.rowIndex)});const o=this.createModelUpdatedEvent();this.eventService.dispatchEvent(o)}destroyCache(){this.infiniteCache&&(this.infiniteCache=this.destroyBean(this.infiniteCache))}onCacheUpdated(){const o=this.createModelUpdatedEvent();this.eventService.dispatchEvent(o)}getRow(o){if(this.infiniteCache&&!(o>=this.infiniteCache.getRowCount()))return this.infiniteCache.getRow(o)}getRowNode(o){let e;return this.forEachNode(t=>{t.id===o&&(e=t)}),e}forEachNode(o){this.infiniteCache&&this.infiniteCache.forEachNodeDeep(o)}getTopLevelRowCount(){return this.getRowCount()}getTopLevelRowDisplayedIndex(o){return o}getRowIndexAtPixel(o){if(this.rowHeight!==0){const e=Math.floor(o/this.rowHeight),t=this.getRowCount()-1;return e>t?t:e}return 0}getRowCount(){return this.infiniteCache?this.infiniteCache.getRowCount():0}isRowPresent(o){return!!this.getRowNode(o.id)}refreshCache(){this.infiniteCache&&this.infiniteCache.refreshCache()}purgeCache(){this.infiniteCache&&this.infiniteCache.purgeCache()}isLastRowIndexKnown(){return this.infiniteCache?this.infiniteCache.isLastRowIndexKnown():!1}setRowCount(o,e){this.infiniteCache&&this.infiniteCache.setRowCount(o,e)}};__decorateClass([(0,import_core3.Autowired)("filterManager")],InfiniteRowModel.prototype,"filterManager",2),__decorateClass([(0,import_core3.Autowired)("sortController")],InfiniteRowModel.prototype,"sortController",2),__decorateClass([(0,import_core3.Autowired)("selectionService")],InfiniteRowModel.prototype,"selectionService",2),__decorateClass([(0,import_core3.Autowired)("rowRenderer")],InfiniteRowModel.prototype,"rowRenderer",2),__decorateClass([(0,import_core3.Autowired)("rowNodeBlockLoader")],InfiniteRowModel.prototype,"rowNodeBlockLoader",2),__decorateClass([import_core3.PostConstruct],InfiniteRowModel.prototype,"init",1),__decorateClass([import_core3.PreDestroy],InfiniteRowModel.prototype,"destroyDatasource",1),InfiniteRowModel=__decorateClass([(0,import_core3.Bean)("rowModel")],InfiniteRowModel);var VERSION="31.2.1",InfiniteRowModelModule={version:VERSION,moduleName:import_core4.ModuleNames.InfiniteRowModelModule,rowModel:"infinite",beans:[InfiniteRowModel]};
